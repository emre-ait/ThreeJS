<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body {
				background-color: #a0a0a0;
			}
		</style>
	</head>
	<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
		<script type="module">
            console.clear();
            import * as THREE from "https://cdn.skypack.dev/three@0.132.2/build/three.module.js";
            import {OrbitControls} from "https://cdn.skypack.dev/three@0.132.2/examples/jsm/controls/OrbitControls.js";
            import Stats from "https://cdn.skypack.dev/three@0.132.2/examples/jsm/libs/stats.module.js";
			import {GUI} from "https://cdn.skypack.dev/three@0.132.2/examples/jsm/libs/dat.gui.module.js";
			import {OBJLoader} from "https://cdn.skypack.dev/three@0.132.2/examples/jsm/loaders/OBJLoader.js";
            
			var scene;
			var camera;
			var renderer;
			var params = {
				color: 0x00ff00
			};
			var gui;
			let object;
			function createScene() {
				gui = new GUI();

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xa0a0a0 );

				camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
				
				renderer = new THREE.WebGLRenderer({physicallyCorrectLights : true, antialias: true, powerPreference: "high-performance"});
				renderer.shadowMap.enabled = true;
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);

				camera.position.z = 1;
				camera.position.y = 1;
				camera.position.x = 1;

				ambientLight();

				var controls = new OrbitControls(camera, renderer.domElement);
				controls.minPolarAngle = 0;
				controls.maxPolarAngle = (80/180)*Math.PI;

				function loadModel() {

					object.traverse( function ( child ) {

						if ( child.isMesh ) {
							console.log(child);
							
							child.material.map = texture;
							child.material.normalMap = textureNormalMap;
							//child.material.aoMap = textureAOMap;
							child.material.map.wrapS = THREE.RepeatWrapping;
							child.material.map.wrapT = THREE.RepeatWrapping;
							child.material.normalMap.wrapS = THREE.RepeatWrapping;
							child.material.normalMap.wrapT = THREE.RepeatWrapping;
							//child.material.aoMap.wrapS = THREE.RepeatWrapping;
							//child.material.aoMap.wrapT = THREE.RepeatWrapping;
							child.material.normalMap.repeat.set(1, 1);

							child.material.map.repeat.set(5, 5);
							//child.castShadow = true;
							
							gui.add(child.material.map.repeat, 'x', 1, 10).step(1).name("Model Repeat").onChange(function() {
								child.material.map.repeat.set(child.material.map.repeat.x,child.material.map.repeat.x);
								child.material.normalMap.repeat.set(1, 1);
								//child.material.normalMap.repeat.set(child.material.map.repeat.x,child.material.map.repeat.x);
							
							});

						}


					} );

					object.position.y = 0;
					object.position.x = 0;
					object.scale.setScalar( 0.01);
					scene.add( object );

					render();

				}
				const manager = new THREE.LoadingManager( loadModel );

				// texture

				const textureLoader = new THREE.TextureLoader( manager );
				const texture = textureLoader.load( './fabric/badilli.png', render );
				const textureNormalMap = textureLoader.load('./fabric/Ekose_normal.jpg', render );
				const textureAOMap = textureLoader.load('./fabric/Ekose_ao.jpg', render );
				const texture2 = textureLoader.load( './fabric/face.jpg', render );
				const hair = textureLoader.load( './fabric/hair.jpg', render );
				texture.colorSpace = THREE.SRGBColorSpace;

				// model

				function onProgress( xhr ) {

					if ( xhr.lengthComputable ) {

						const percentComplete = xhr.loaded / xhr.total * 100;
						console.log( 'model ' + percentComplete.toFixed( 2 ) + '% downloaded' );

					}

				}

				function onError() {}

				const loader = new OBJLoader( manager );
				loader.load( './obj/sofacabochon.obj', function ( obj ) {

					object = obj;

				}, onProgress, onError );

				//


				
				//createBox('box1', 1, 1, 1, 0, 0.5, 0, './fabric/1');
				createBox('floor', 10, 1, 10, 0, -0.5, 0, './floor/WoodFloor');
				
				var camPos = gui.addFolder('Camera Position');
				
				camPos.add(camera.position, 'x', -20, 20).step(0.1).onChange(function() {
					camera.position.x = camera.position.x;
				});
				camPos.add(camera.position, 'y', -20, 20).step(0.1).onChange(function() {
					camera.position.y = camera.position.y;
				});
				camPos.add(camera.position, 'z', -20, 20).step(0.1).onChange(function() {
					camera.position.z = camera.position.z;
				});
				camera.lookAt(new THREE.Vector3(0, 0, 0));

				// var fp = gui.addFolder('Position');
				// var fr = gui.addFolder('Rotation');
				// var fc = gui.addFolder('Color');
				// fp.add(scene.getObjectByName('box1').position, 'x', 0, 5);
				// fp.add(scene.getObjectByName('box1').position, 'y', 0, 5);
				// fp.add(scene.getObjectByName('box1').position, 'z', 0, 10);
				// fr.add(scene.getObjectByName('box1').rotation, 'x', 0, 5);
				// fr.add(scene.getObjectByName('box1').rotation, 'y', 0, 5);
				// fr.add(scene.getObjectByName('box1').rotation, 'z', 0, 10);
				// fc.addColor(params, 'color').onChange(function() {
				// 	scene.getObjectByName('box1').material.color.set(params.color);
				// });

				//var gridHelper = new THREE.GridHelper(5, 10, 0xff0000, 0x808080);
				//scene.add(gridHelper);
				//var axesHelper = new THREE.AxesHelper(1);
				//scene.add(axesHelper);
				//var arrowHelper = new THREE.ArrowHelper(new THREE.Vector3(1, 1, 1), new THREE.Vector3(0, 0, 0), 1, 0xff0000);
				//scene.add(arrowHelper);

				createSpotLight();
			
				render();
			}

			function render() {
				renderer.render(scene, camera);
				//scene.getObjectByName('box1').rotation.x += 0.01;
				requestAnimationFrame(render);
			}

			function createBox(name, w, h, d, x, y, z, texture) {
				var repeatcount = 1;
				var geometry = new THREE.BoxGeometry(w, h, d, 100, 100, 100);
				var material = new THREE.MeshStandardMaterial({color: 0xffffff});
				var loader = new THREE.TextureLoader();
				material.map = loader.load(texture + '.jpg');
				material.normalMap = loader.load(texture + '_normal.jpg');
			
				if (name == 'floor') {
					material.map.wrapS = THREE.RepeatWrapping;
					material.map.wrapT = THREE.RepeatWrapping;
					material.map.repeat.set(5, 5);
					material.normalMap.wrapS = THREE.RepeatWrapping;
					material.normalMap.wrapT = THREE.RepeatWrapping;
					material.normalMap.repeat.set(5, 5);
					gui.add(material.map.repeat, 'x', 0, 10).step(1).name("Floor Repeat").onChange(function() {
						material.map.repeat.set(material.map.repeat.x,material.map.repeat.x);
						material.normalMap.repeat.set(material.map.repeat.x,material.map.repeat.x);
					});
				}
				
				var mesh = new THREE.Mesh(geometry, material);
				mesh.position.set(x, y, z);
				mesh.name = name;
				mesh.castShadow = true;
				mesh.receiveShadow = true;
				scene.add(mesh);
			}
			function createSpotLight() {
				var spotpos = gui.addFolder('SpotLight Position');
				var spotset = gui.addFolder('SpotLight Settings');
				var spotTarget = gui.addFolder('SpotLight Target');
				var spotLight = new THREE.SpotLight(0xffffff);
				spotLight.position.set(2, 4, 6);
				spotLight.castShadow = true;
				spotLight.shadow.mapSize.width = 4096;
				spotLight.shadow.mapSize.height = 4096
				
				var target = new THREE.Object3D();
				target.position.set(0,0,0,);
				spotLight.target = target;

				spotset.add(spotLight, 'penumbra', 0, 1).step(0.01).onChange(function() {
					spotLight.shadow.penumbra = spotLight.penumbra;
				});
				spotset.add(spotLight, 'intensity', 0, 10).step(1).onChange(function() {
					spotLight.intensity = spotLight.intensity;
				});
				spotset.add(spotLight, 'distance', 0, 100).step(1).onChange(function() {
					spotLight.distance = spotLight.distance;
				});
				spotset.add(spotLight, 'decay', 0, 10).step(1).onChange(function() {
					spotLight.decay = spotLight.decay;
				});
				spotset.add(spotLight, 'power', 0, 10).step(1).onChange(function() {
					spotLight.intensity = spotLight.intensity;
				});
				spotpos.add(spotLight.position, 'x', -10, 10).step(0.1).onChange(function() {
					spotLight.position.x = spotLight.position.x;
				});
				spotpos.add(spotLight.position, 'y', -10, 10).step(0.1).onChange(function() {
					spotLight.position.y = spotLight.position.y;
				});
				spotpos.add(spotLight.position, 'z', -10, 10).step(0.1).onChange(function() {
					spotLight.position.z = spotLight.position.z;
				});
				spotTarget.add(target.position, 'x', -10, 10).step(0.1).onChange(function() {
					target.position.x = target.position.x;
				});
				spotTarget.add(target.position, 'y', -10, 10).step(0.1).onChange(function() {
					target.position.y = target.position.y;
				});
				spotTarget.add(target.position, 'z', -10, 10).step(0.1).onChange(function() {
					target.position.z = target.position.z;
				});
				//var helper = new THREE.SpotLightHelper(spotLight);
				//scene.add(helper);
				//var cameraHelper = new THREE.CameraHelper(spotLight.shadow.camera);
				//scene.add(cameraHelper);

				scene.add(spotLight);
				scene.add(target);
			}

			function ambientLight() {
				var ambientLight = new THREE.AmbientLight(0x404040, 1);
				ambientLight.castShadow = true;
				scene.add(ambientLight);
			}

			createScene();



    </script>
	</body>
</html>